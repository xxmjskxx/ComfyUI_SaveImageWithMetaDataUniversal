# Changelog

All notable changes to this project will be documented in this file.

## [Unreleased]
### Changed
- `generated_user_rules.py` now begins with a descriptive docstring explaining that the file is auto-generated by
	the Metadata Rule Scanner / Save Custom Metadata Rules nodes and will be overwritten whenever you regenerate
	rules. This makes it obvious to future reviewers that edits belong in `user_captures.json` / `user_samplers.json`.

## [1.3.0] - 2025-11-18
### Highlights
This is a major consolidation release bringing together 219 commits of improvements, bug fixes, and enhancements. Key focus areas include LoRA/embedding handling, user rule system improvements, scanner enhancements, comprehensive testing, and extensive documentation.

### Added - LoRA & Embedding System
- **Opt-in inline LoRA parsing**: Added `inline_lora_candidate` flag to prompt captures, restricting `<lora:...>` tag parsing to only nodes that explicitly opt in, preventing incidental prompt scans.
- **Enhanced LoRA manager**: Now inspects multiple structured fields (`lora_stack`, `loras`, `loaded_loras`, etc.) before falling back to plain text parsing, properly surfacing names, hashes, and per-slot strengths from LoRA Loader/Text Loader nodes including string-fed syntax.
- **Cached embedding hashes**: Scanner and capture now use cached embedding hashes for improved performance.
- **Per-node strength alignment**: Revamped LoRA strength tracking to preserve strengths per node instance.
- **Dedicated clip-strength selector**: PCLazyLoraLoader nodes now keep separate model/CLIP strength lists and expose dedicated clip-strength selectors.

### Added - User Rule System
- **Selective rule merging**: `load_user_definitions` now accepts `required_classes` parameter with `allowed_user_classes` handling. When provided, user JSON entries are only merged for explicitly requested or forced classes, allowing coverage-satisfied test runs to ignore unrelated user-only nodes while still applying targeted overrides and forced includes.
- **Legacy behavior preserved**: Global loads (`required_classes is None`) still load every user entry, maintaining compatibility for rule scanner workflows and migration tests.
- **Version tracking system**: Added `version.py` module with rule version tracking and outdated rule warnings.

### Added - Scanner Enhancements
- **Priority keywords**: Scanner now supports `priority_keywords` for better node prioritization during rule generation.
- **Improved heuristics**: Adjusted sampler selection and metadata field detection heuristics.
- **Better LoRA/embedding detection**: Fixed scanner handling of LoRAs and embeddings with proper hash resolution.

### Added - Testing & Validation
- **Comprehensive test coverage**: New tests including `test_lora_manager_selectors.py`, `test_pclazy_hashes.py`, regression tests for inline LoRA opt-in, strength preservation, and clip duplication fixes.
- **CLI validation tools**: Enhanced workflow validation scripts with verbose mode, metadata dump capabilities, workflow tracing, and comprehensive field validation.
- **Integration tests**: Added `test_validate_metadata_integration.py` for end-to-end validation testing.
- **Test organization**: Moved various development tools to `tests/tools` directory for better organization.

### Added - Documentation & Developer Experience
- **Comprehensive docstrings**: Added detailed docstrings to all Python files covering purpose, inputs, outputs, and environment flag dependencies.
- **Enhanced copilot instructions**: Updated and expanded `.github/copilot-instructions.md` and related instruction files.
- **Inline documentation**: Added explanatory comments to empty except clauses and complex logic sections.
- **Example workflows**: Added/updated workflows including `refresh-rules.json` and efficiency testing workflows.

### Added - Infrastructure & Tooling
- **Python 3.13 support**: Added Python 3.13 to CI matrix in `unimeta-ci.yml`.
- **Hash validation paths**: Updated validation scripts with `--extra-workflows` option and improved hash validation paths.
- **Workflow analysis tools**: Comprehensive workflow MetaFields analysis and tracing capabilities.

### Changed - LoRA Processing
- **Fixed "Schedule LoRAs" clip duplication**: PCLazyLoraLoader selectors now properly handle model vs CLIP strengths separately, fixing metadata duplication.
- **LoRA stack source tracking**: Caching now tracks originating field to avoid stale data when sources change.
- **Improved strength alignment**: Better per-node strength preservation across different LoRA loader types.

### Changed - Capture System
- **Inline LoRA gating**: `Capture.get_inputs` now remembers which prompt nodes opt into inline parsing, differentiating between prompt-only workflows (scan entire prompt graph) and workflows with prompts that didn't opt in.
- **Selective prompt scanning**: Added `inline_filter` gate and `should_attempt_inline` check to prevent false positives.
- **Better error handling**: `_append_loras_from_text` no longer swallows exceptions silently, now uses structured logging.
- **Metadata value bug fixes**: Corrected metadata value generation in `selectors.py`, `__init__.py`, and `capture.py`.

### Changed - Code Quality
- **Structured logging**: Replaced silent exceptions with proper module-level logging throughout.
- **Better exception handling**: Narrowed broad `Exception` catches to specific types (OSError, etc.) where appropriate.
- **Improved docstrings**: Fixed incorrect docstrings (e.g., `coerce_first` in `lora.py`) with accurate contract descriptions.
- **Type safety**: Mypy fixes across the codebase.
- **Code organization**: Better separation of concerns and clearer function contracts.

### Changed - Testing Infrastructure
- **Efficiency validation improvements**: `run_efficiency_validation.py` now starts from `DEFAULT_COMFY_EXTRA.copy()` after parsing, properly honors `workflow_dir` parameter, and logs reasons for `/object_info` polling failures.
- **CLI helper improvements**: Tightened helpers without Windows-only assumptions or ambiguous parsing.
- **Cookiecutter fixes**: Updated post-generation hook to use proper Jinja boolean expressions.
- **Piexif alias improvements**: Fallback path now consumes installed modules when available and re-exports them, eliminating unused-import warnings.

### Fixed - Critical Bugs
- **Repeating startup banner**: Fixed startup message printing multiple times on module reload with session-based deduplication.
- **LoRA hash calculation**: Fixed hash resolution and caching bugs affecting LoRA metadata accuracy.
- **Metadata value bugs**: Fixed incorrect metadata values being generated by selectors and capture logic.
- **Validation script bugs**: Fixed critical bugs in validation scripts affecting workflow testing accuracy.

### Fixed - Test Issues
- **test_validate_metadata_integration.py**: Fixed errors preventing integration tests from passing.
- **Test file cleanup**: Removed test result files from repository, updated `.gitignore` appropriately.
- **CI cookiecutter issues**: Fixed template generation issues affecting CI builds.
- **Linting issues**: Fixed various ruff linting violations and formatting inconsistencies.

### Removed
- **Cleaned up artifacts**: Deleted `__pycache__` directories and updated `.gitignore` to prevent future commits.
- **Obsolete test files**: Removed outdated test documentation and completion summaries from `tests/comfyui_cli_tests/`.
- **Stale code**: Removed unused code and commented-out defaults that no longer matched behavior.

### Internal
- **Repository cleanup**: Better `.gitignore` configuration to exclude build artifacts and test outputs.
- **Documentation organization**: Improved structure of test documentation and workflow examples.
- **Code archaeology**: Removed mjsk-specific references from tests for better generalization.

## [1.2.4] - 2025-11-12
### Changed
- Changelog corrected to accurately attribute ComfyUI 0.3.65+ compatibility fix to 1.2.3 (added Errata under 1.2.2).

### Internal
- Merge PR #53 (documentation alignment); no functional code changes beyond prior releases.

### Notes
- Pure documentation / release metadata correction; users on 1.2.3 already have the fix.

## [1.2.3] - 2025-11-13
### Fixed
- Resolved AttributeError in ComfyUI 0.3.65+ cache flows (compat wrapper + capture robustness).
- Added missing `get_cache` alias ensuring forward compatibility (Issue #29 continuity from prior groundwork).
- Minor README clarifications (rerun nodes note) and typo corrections.

### Changed
- Path normalization (`_test_outputs` → `tests/_test_outputs`) carried forward; documentation note on workflow rerun behavior.

### Internal
- Merge PR #51 and #52 consolidated compatibility work introduced earlier but not present in v1.2.2 tag.
- Backfills release notes accuracy for earlier mistaken attribution.

### Notes
- This release contains the compatibility fix previously (incorrectly) listed under 1.2.2. See 1.2.2 Errata.

## [1.2.2] - 2025-11-12
### Fixed
- Lint compliance adjustments to test metadata validation script (`validate_metadata.py`) for ruff 120 char limit.
- Minor sampler name recovery heuristics documented (no breaking changes).

### Changed
- Improved error message formatting for LoRA name mismatches and missing LoRAs.
- Structured internal functions now use wrapped long lines for readability within tooling constraints.
- Added ComfyUI cli test scripts and workflows to `tests\comfyui_cli_tests`.
- Changed all references of `_test_outputs` to `tests/_test_outputs`.
- Update version in `saveimage_unimeta/capture.py` to 1.2.2.

### Internal
- Follow‑up to undocumented 1.2.1; consolidates sampler fallback and validation script lint compliance.
### Errata
- The ComfyUI 0.3.65+ AttributeError fix and `get_cache` alias were not in the v1.2.2 tag; they landed later and are correctly part of 1.2.3.

## [1.2.1] - 2025-10-15
### Added
- Compatibility wrapper `_OutputCacheCompat` for evolving ComfyUI API (supports `get_output_cache`).
- Expanded CLI workflow validation utilities (`tests/comfyui_cli_tests/validate_metadata.py`, workflow JSON fixtures) covering sampler, prompt, LoRA, embedding, size, and fallback scenarios.
- Additional workflow test JSONs for large JPEG/WebP metadata fallback edge cases and dual‑prompt Flux variants.
- Test `test_output_cache_compat.py` ensuring wrapper behavior.

### Changed
- Refined capture traversal to gracefully skip absent prompt executer caches without aborting image save.
- Improved sampler name recovery heuristics (graph introspection + token scan) prior to 1.2.2 robustness tweaks.
- Cleaned test imports & trimmed legacy artifacts for faster CI feedback.

### Fixed
- Minor path and casing inconsistencies in workflow test fixtures.
- Early fallback handling for missing Flux dual prompts (T5 / CLIP) in validation paths.

### Internal
- Foundation work preparing for 1.2.2 capture robustness; this release documents previously unrecorded changes between v1.2.0 and v1.2.2.

## [1.2.0] - 2025-09-26
### Added
- Tests: missing-only lens behavior, forced sampler role retention, scanner cache path parity.
- Dummy `KSampler` test shim for stable sampler detection under test mode.
- Benchmark relocated to `tests/bench/bench_merge_performance.py` (no runtime surface impact).
- Initial coverage threshold enforcement (fail-under 35%) with multi-version matrix (3.10–3.12).
- Baseline rule cache in `Metadata Rule Scanner` (diff report: `BaselineCache=hit:X|miss:Y`).
- Dropdown backup restore selector for `Save Custom Metadata Rules` (`restore_backup_set`).
- Central diff parsing helper (`tests/diff_utils.parse_diff_report`).
- Scanner tests for forced metafield retention and cache hit accounting.

### Changed
- Scanner semantics clarified: `include_existing=False` activates missing-only lens (documentation + logs). (Interim experiment to default True was reverted before release; final default remains False — no breaking change to prior public behavior.)
- Unified test artifact isolation: writer, loader, and scanner prefer `_test_outputs/user_rules` in `METADATA_TEST_MODE`.
- Path parity updates for user rule JSON (writer + scanner mtime cache logic).
- Moved `MIGRATIONS.md` to `docs/`.
- Consolidated dual CI workflows into single `unimeta-ci.yml` (matrix tests, coverage, strict & autofix lint jobs).
- Clarified scanner `include_existing` tooltip (explicit include vs missing-only lens when disabled) and expanded `rules_json_string` tooltip (schema guidance, allowed rule keys).

### Removed
- Root `folder_paths.py` test stub (tests supply their own stub early).
- Legacy example user rule JSON files and obsolete design scratch file.

### Fixed
- Loader runtime test-mode path detection (ensures user JSON merges correctly under coverage import order).
- Coverage “No source for code” error: placeholder `generated_user_rules.py` + coverage omit.
- Timestamp helper now validates optional `-N` suffix correctly.
- Failing append placeholder test due to path mismatch after isolation changes.
- Potential stale baseline in scanner cache when isolated test directory used.
- Narrowed broad `Exception` catches in migration fallback to `OSError` (reduces risk of swallowing logic errors).
- Removed duplicate registration block in missing-lens sampler roles test.
- Minor tooltip long-line wrapping & consistency adjustments across nodes.

## [1.1.2] - 2025-09-26
### Added
- Collapsible README section pattern unified ("More:" details blocks) for improved scanability.
- Migration guide relocated to `docs/MIGRATIONS.md` (clearer docs structure).
### Changed
- README Quick Start simplified (heading outside collapsible + consistent details styling).
- Refined documentation anchors & internal links for fallback tips and parameters.
### Fixed
- Benchmark script now ensures `_test_outputs` directory exists before writing JSON output.
- Eliminated duplicated `METADATA_TEST_MODE` parsing in tests via new `metadata_test_mode` fixture (reduces drift risk).

## [1.1.1] - 2025-09-25
### Added
- Benchmark script `bench_merge_performance.py` (verifies sampler merge helper adds <5% overhead; ~4.8% in synthetic test).
- Negative tests for malformed capture and sampler user JSON structures (ignored safely without clobbering).
- CI matrix expanded to run with and without `METADATA_TEST_MODE` across supported Python versions.
### Changed
- Refactored loader merge logic: extracted `_merge_user_sampler_entry`, `_merge_extension_capture_entry`, `_merge_user_capture_entry` for clarity & maintainability.
- Simplified sampler per-key merge with validation and shallow update semantics encapsulated in helper.
- Clarified `METADATA_TEST_MODE` parsing (only explicit truthy tokens enable test mode; "0" no longer truthy).
- Improved readability of selector utilities (updated `selectors.py`).
### Fixed
- Loader now skips non-mapping sampler entries instead of overwriting with invalid data.
- Conditional tests now skip gracefully when baseline definitions intentionally empty under test mode.

## [1.1.0] - 2025-09-24
Note: 1.0.0 was the first public registry release; this minor release formalizes post‑1.0 refactor cleanup (shim removal) and new UI/node enhancements.

### Added
- Node: `Show Any (Any to String)` — accepts any input, converts to STRING, displays on canvas; supports batching.
- Frontend: `web/show_text_unimeta.js` extended to handle `ShowAny|unimeta` and `ShowText|unimeta` with robust payload parsing.
- Frontend: Dynamic textarea sizing and node recompute to reduce overlap at small zoom levels.
- Tests: `tests/test_show_any.py` covering `_safe_to_str`, UI/result shapes, workflow widget persistence, and wildcard `AnyType` semantics.
- Docs: Expanded README sections (ToC sync, sampler selection, metadata list, JPEG fallback tips). Japanese README aligned to English.
- Save node option `suppress_missing_class_log` to suppress informational missing class list log (reduces noise in large graphs).

### Changed
- Frontend separation: `web/show_text.js` now targets base `ShowText` only to avoid double initialization with UniMeta variants.
- Improved truncation suffix documentation and test expectations for `_safe_to_str`.
- Removed legacy compatibility shim `saveimage_unimeta/nodes/node.py`; direct imports now required:
	- `SaveImageWithMetaDataUniversal` → `saveimage_unimeta.nodes.save_image`
	- `SaveCustomMetadataRules` → `saveimage_unimeta.nodes.rules_writer`
	- `MetadataRuleScanner` → `saveimage_unimeta.nodes.scanner`
	- Centralized EXIF test monkeypatch target: `saveimage_unimeta.piexif_alias.piexif`.

### Fixed
- Prevented double widget injection causing textarea overlap in UniMeta nodes.
- UI display not updating for `ShowAny|unimeta` in certain payload shapes (now reads `message.ui.text`).
- Readme anchor correction for `Format & Fallback Quick Tips`.

## [0.2.0] - 2025-09-19
### Added
- `MetadataRuleScanner` scanning node (rule suggestion) separate from force include config.
- `MetadataForceInclude` node to manage globally forced node class names.
- Global registry `FORCED_INCLUDE_CLASSES` with helpers: `set_forced_include`, `clear_forced_include`.

### Changed
- Split concerns: scanning vs forced class configuration (previous single scanner responsibilities divided into two nodes).
- Improved description wrapping for `SaveImageWithMetaDataUniversal` to satisfy style guidance.

### Metadata Fallback
- Maintained multi-stage JPEG metadata fallback: full EXIF → reduced-exif → minimal → COM marker with fallback annotation.

### Notes
- Remaining long lines in `node.py` are legacy and will be incrementally cleaned.

---

[Unreleased]: https://github.com/xxmjskxx/ComfyUI_SaveImageWithMetaDataUniversal/compare/v1.3.0...HEAD
[1.3.0]: https://github.com/xxmjskxx/ComfyUI_SaveImageWithMetaDataUniversal/compare/v1.2.4...v1.3.0
[1.2.4]: https://github.com/xxmjskxx/ComfyUI_SaveImageWithMetaDataUniversal/compare/v1.2.3...v1.2.4
[1.2.3]: https://github.com/xxmjskxx/ComfyUI_SaveImageWithMetaDataUniversal/compare/v1.2.2...v1.2.3
[1.2.2]: https://github.com/xxmjskxx/ComfyUI_SaveImageWithMetaDataUniversal/compare/v1.2.1...v1.2.2
[1.2.1]: https://github.com/xxmjskxx/ComfyUI_SaveImageWithMetaDataUniversal/compare/v1.2.0...v1.2.1
[1.2.0]: https://github.com/xxmjskxx/ComfyUI_SaveImageWithMetaDataUniversal/compare/v1.1.2...v1.2.0

## [0.1.0] - 2025-09-20 (Initial Internal Release)
Baseline derived from upstream [`nkchocoai/ComfyUI-SaveImageWithMetaData`](https://github.com/nkchocoai/ComfyUI-SaveImageWithMetaData/) with extensive architectural and feature expansion aggregated prior to release.

### Nodes Introduced
| Node | Purpose |
| ---- | ------- |
| `SaveImageWithMetaDataUniversal` | Core image save + enriched metadata & parameters (PNGInfo / EXIF / WebP). |
| `Metadata Rule Scanner` | Analyze installed nodes, suggest capture rules & sampler associations. |
| `Save Custom Metadata Rules` | Persist accepted rule suggestions to user rules file. |
| `Metadata Force Include` | Manage globally forced node class names for guaranteed capture. |
| `Create Extra MetaData` | Inject arbitrary additional key-value pairs. |
| `Show generated_user_rules.py` | Display merged user rules for review/edit. |
| `Save generated_user_rules.py` | Validate and write edited rules back to disk. |
| `Show Text (UniMeta)` | Display connected text outputs (local variant). |

### Core Additions
- Universal capture pipeline (`Capture` + dynamic rule loading) covering prompts, models, VAEs, LoRAs, embeddings, samplers, guidance, shift, clip models.
- Multi-format save: PNG (PNGInfo), lossless WebP, JPEG (EXIF) with staged fallback and parameter string annotation.
- Dynamic rule generation workflow: `Metadata Rule Scanner` + `Save Custom Metadata Rules` nodes; persisted user rule file merge logic.
- Global forced include management via `Metadata Force Include` node and `FORCED_INCLUDE_CLASSES` registry.
- Parameter string generation aligned with Automatic1111 style (single-line) plus test mode (multiline) for deterministic snapshots.
- Hash caching using `.sha256` sidecars for model, VAE, LoRA (truncated SHA256 display, reused once computed).
- LoRA detection (single, stacked loaders, inline prompt tags) with optional summary + per-item detail lines.
- Filename token system with truncation (`%pprompt:[n]%`, `%model:[n]%`, timestamp patterning).
- Environment flag system (runtime evaluated) for hash detail suppression, LoRA summary suppression, test mode formatting, and prompt debug logging.

### JPEG Metadata Fallback System
- Size-aware staged degradation: full → reduced-exif → minimal → com-marker.
- Minimal stage allowlist retains prompts, sampler core settings, seed, model/vae names+hashes, hash summary, generator version, LoRAs.
- Automatic annotation `Metadata Fallback: <stage>` appended only once to parameter string.
- Configurable UI cap `max_jpeg_exif_kb` (hard limit 64KB) with recommendations.

### Sampler & Graph Intelligence
- BFS trace + sampler heuristic selection (`Trace`) with distance-based selection modes (Farthest, Nearest, By node ID).
- Heuristic fallback when sampler not explicitly matched (based on presence of key metafields like Steps/CFG).

### Metadata Integrity & Ordering
- Stable key ordering; only append new fields to avoid churn.
- Consistent trimming rules for minimal fallback to preserve downstream parsing reliability.
- Comma replacement with `/` in extra metadata values to avoid downstream naive split issues.

### Developer / Maintenance Enhancements
- Central AI assistant instructions (`.github/copilot-instructions.md`) describing architecture, constraints, safe-edit rules.
- Expanded README with quick tips, fallback behavior explanation, environment flags table, filename token reference.
- Logging over raw prints; debug flags for prompt capture.
- Testing support: multiline deterministic parameters under `METADATA_TEST_MODE`.

### Archived / Deferred (Documented Separately)
- Archived prototype in `web/disabled/metadata_rule_scanner/` (editor UI) documented in `docs/FUTURE_AND_PROTOTYPES.md`.
- Workflow compression placeholder design (`docs/WORKFLOW_COMPRESSION_DESIGN.md`).

### Compatibility / Interop
- Civitai-aligned sampler & CFG mapping option (`guidance_as_cfg`, `civitai_sampler`).
- Lossless WebP parity with PNG for workflow embedding.

### Security / Performance
- Avoid repeated hashing by sidecar reuse; truncated display for readability.
- No multi-segment EXIF writes (explicitly out-of-scope for simplicity & compatibility).

### Breaks / Differences From Upstream
- Separation of scanning vs forced include responsibilities into dedicated nodes.
- JPEG fallback semantics and parameter string marker (not present upstream).
- Extended LoRA and embedding hashing & display structures.
- Environment flag driven runtime behavior toggles (no restart required).

---

